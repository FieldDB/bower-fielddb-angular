"use strict";angular.module("fielddbAngularApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","angularFileUpload","contenteditable","ngDragDrop"]).config(["$routeProvider",function(a){console.log(a)}]),angular.module("fielddbAngularApp").controller("FieldDBController",["$scope","$routeParams","$rootScope",function(a,b,c){a.connection={online:!0,apiURL:"https://localhost:3181/v2/",offlineCouchURL:"https://localhost:6984"},FieldDB.FieldDBConnection.connection.localCouch.url=FieldDB.BASE_DB_URL,a.authentication={};var d=function(){if(!b||!b.team)return void console.log("Route params are undefined, not loading anything");a.loginDetails.username=b.team,c.currentCorpusDashboard=b.team+"/"+b.corpusid;var d=new FieldDB.UserMask({username:"team"});if(d.dbname=d.validateUsername(b.team).username+"-"+d.validateUsername(b.corpusid).username,d.dbname.split("-").length<2)return void(a.status="Please try another url of the form teamname/corpusname "+d.dbname+" is not valid.");a.team=d;var e=new FieldDB.Corpus({dbname:d.dbname});console.log(e.toJSON()),a.corpus=e,a.corpora=null,a.thisyear=(new Date).getFullYear(),a.team.gravatar||(a.status="Loading team details.",d.fetch(FieldDB.FieldDBConnection.connection.localCouch.url).then(function(b){console.log("Suceeded to download team public details.",b),c.status="Loaded team details.",a.$apply()},function(b){console.log("Failed to download team public details.",b),c.status="Failed to download team public details.",a.$apply()})),a.corpus.title||(a.status="Loading corpus details.",e.loadOrCreateCorpusByPouchName(e.dbname).then(function(b){console.log("Suceeded to download corpus details.",b),c.status="Loaded corpus details.",a.$apply()},function(b){console.log("Failed to download corpus details.",b),c.status="Failed to download corpus details. Are you sure this is the corpus you wanted to see: "+e.dbname,a.$apply()}).catch(function(a){console.log(a)}))};d(),console.log("In the FieldDBController",a.connection)}]),angular.module("fielddbAngularApp").directive("fielddbCorpus",function(){var a={templateUrl:"views/corpus.html",restrict:"A",transclude:!1,scope:{corpus:"=json"},link:function(){},priority:0,replace:!1,controllerAs:"stringAlias"};return a}),angular.module("fielddbAngularApp").directive("fielddbUser",function(){return{templateUrl:"views/user.html",restrict:"A",transclude:!1,scope:{user:"=json"},link:function(){}}}),angular.module("fielddbAngularApp").directive("fielddbSearch",function(){var a={};return a.sortBy="dateCreated",a.fields=["utterance","translation"],{templateUrl:"views/search.html",restrict:"A",transclude:!1,scope:!0,link:function(b,c,d){console.log(d),b.search=a}}}),angular.module("fielddbAngularApp").directive("fielddbCorpusTermsOfUse",function(){return{templateUrl:"views/terms-of-use.html",restrict:"A",transclude:!1,scope:{corpus:"=json"},link:function(){}}}),angular.module("fielddbAngularApp").directive("fielddbOfflineControls",function(){return{templateUrl:"views/offline-controls.html",restrict:"A",transclude:!1,scope:{connection:"=json"},link:function(){}}}),angular.module("fielddbAngularApp").factory("fielddbStorage",["$rootScope",function(a){var b="",c="testingphophlo-debugging";FieldDB.BASE_DB_URL="https://corpusdev.example.org",FieldDB.BASE_AUTH_URL="https://authdev.example.org";var d,e=[],f=function(c){FieldDB.CORS.makeCORSRequest({type:"GET",dataType:"json",url:FieldDB.BASE_DB_URL+"/_session"}).then(function(d){console.log(d),d.ok&&(b=d.userCtx.name,a.authenticated=!0,d.userCtx.roles.map(function(a){var b=a.substring(0,a.lastIndexOf("_"));a.indexOf("-")>-1&&a.indexOf("_reader")>-1&&-1===e.indexOf(b)&&e.push(b)}),console.log(e)),"function"==typeof c&&c()})};return{getCollection:function(a){var e=FieldDB.Q.defer(),g=function(){d=d||new FieldDB.PsycholinguisticsDatabase({username:b,dbname:c,url:FieldDB.BASE_DB_URL,authUrl:FieldDB.BASE_AUTH_URL}),console.log("fetching docs for ",d.toJSON()),d.fetchCollection(a).then(function(a){console.log("downloaded ",a),e.resolve(a.rows.map(function(a){return a.value}))},function(a){console.log("No docs...",a),e.reject(a)})};return b?g():f(g),e.promise},dbUrl:function(){return FieldDB.BASE_DB_URL+"/"+c}}}]),angular.module("fielddbAngularApp").directive("fielddbAuthentication",function(){FieldDB.BASE_DB_URL="https://corpusdev.lingsync.org",FieldDB.BASE_AUTH_URL="https://authdev.lingsync.org";var a=function(a,b){a.loginDetails=a.loginDetails||{},a.authentication=a.authentication||{},a.authentication.user=a.authentication.user||{accessibleDBS:[]},console.log("Scope authentication is ",a);var c=function(c){c.authenticated=!0,c.accessibleDBS=c.accessibleDBS||[],a.authentication.user=c,c.roles.map(function(a){var b=a.substring(0,a.lastIndexOf("_"));a.indexOf("-")>-1&&a.indexOf("_reader")>-1&&-1===c.accessibleDBS.indexOf(b)&&c.accessibleDBS.push(b)}),console.log(a),("/welcome"===window.location.pathname||"/bienvenu"===window.location.pathname)&&a.$apply(function(){b.path("/"+a.authentication.user.accessibleDBS[0].replace("-","/"))}),a.$digest()};a.register=function(a){console.warn("TODO",a)},a.login=function(b){a.isContactingServer=!0,a.authentication.error="";var d=new FieldDB.PsycholinguisticsDatabase({username:b.username,dbname:"default",url:FieldDB.BASE_DB_URL,authUrl:FieldDB.BASE_AUTH_URL});d.login(b).then(function(a){console.log("User has been downloaded. ",a),c(a)},function(b){a.authentication.error=b}).catch(function(){a.isContactingServer=!1,a.loginDetails.password="",a.$digest()}).done(function(){a.isContactingServer=!1,a.loginDetails.password="",a.$digest()})},a.logout=function(){a.authentication.error="";var c=new FieldDB.PsycholinguisticsDatabase({username:a.loginDetails.username,dbname:"default",url:FieldDB.BASE_DB_URL,authUrl:FieldDB.BASE_AUTH_URL});c.logout().then(function(c){console.log("User has been logged out. ",c),a.authentication={},"/welcome"!==window.location.pathname&&"/bienvenu"!==window.location.pathname&&a.$apply(function(){b.path("/welcome/")}),a.$digest()},function(b){a.authentication.error=b,a.$digest()}).done(function(){a.isContactingServer=!1,a.$digest()})},a.resumeAuthenticationSession=function(){FieldDB.CORS.makeCORSRequest({type:"GET",dataType:"json",url:FieldDB.BASE_DB_URL+"/_session"}).then(function(d){console.log(d),d.ok&&d.userCtx.name?(a.authentication.user.username=d.userCtx.name,a.authentication.user.roles=d.userCtx.roles,c(a.authentication.user)):a.$apply(function(){b.path("/welcome")})},function(b){console.log("Unable to login ",b),a.error="Unable to resume.",a.$digest()})},a.resumeAuthenticationSession()};a.$inject=["$scope","$location"];var b={templateUrl:"views/authentication.html",restrict:"A",transclude:!1,controller:a,link:function(){},priority:0,replace:!0,controllerAs:"stringAlias"};return b}),angular.module("fielddbAngularApp").directive("fielddbImport",function(){var a=function(a,b){var c=!0,d=function(a){console.log("percent: "+parseInt(100*a.loaded/a.total))},e=function(a,b,c,d){console.log(a,b,c,d)};a.removeRow=function(b){console.log("remove ",b);var c=a.importer.asCSV.splice(b,1);console.log(c)},a.onFileSelect=function(f){if(c)a.importer=a.importer||new FieldDB.Import({files:f,corpus:a.corpus,dbname:a.corpus.dbname,status:"",error:"",rawText:"",importType:"participants"}),console.log(a.importer),a.importer.readFiles({}).then(function(b){console.log("Finished reading files ",b),a.$digest(),a.importer.guessFormatAndPreviewImport(),a.$digest()},function(b){console.log("Error reading files ",b),a.$digest()});else for(var g=0;g<f.length;g++){var h=f[g];a.upload=b.upload({url:"server/upload/url",data:{myObj:a.myModelObj},file:h}).progress(d).success(e)}},a.locale={locale_Import_First_Step:"Step 1: Drag & drop, copy-paste or type your data into the text area, or select audio/video file(s) from your computer. Yes, you can edit the data inside the text area.",locale_Import_Second_Step:"Step 2: Drag and drop or type the field names in column headers. Edit data in the table as needed.",locale_Add_Extra_Columns:"Insert Extra Columns",locale_Attempt_Import:"Preview Import",locale_Import_Third_Step:"Step 3: The imported data will look like this. Edit in the table or the text area above as needed. Edit the datalist title and description, and the eliciation session section before finishing import.",locale_Import:"Importer des liste(s) de classe (.csv)",locale_Drag_and_Drop_Placeholder:"Drag and drop files, copy-paste or type your data here. (Or use the Choose file(s) button)"}};a.$inject=["$scope","$upload"];var b={templateUrl:"views/import.html",restrict:"A",transclude:!1,controller:a,link:function(){},priority:0,replace:!1,controllerAs:"stringAlias"};return b}),angular.module("fielddbAngularApp").directive("fielddbParticipants",function(){var a={templateUrl:"views/participants.html",restrict:"A",transclude:!1,scope:{participants:"=json"},link:function(){},priority:0,replace:!1,controllerAs:"stringAlias"};return a});